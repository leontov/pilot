#!/bin/bash
# –°–∫—Ä–∏–ø—Ç –¥–ª—è –∑–∞–ø—É—Å–∫–∞ –º–Ω–æ–∂–µ—Å—Ç–≤–∞ —É–∑–ª–æ–≤ kolibri_node_v1 –∏ —Å–≤—è–∑—ã–≤–∞–Ω–∏—è —Å –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–æ–º

MAX_NODES=300
BASE_PORT=9000

# –ï—Å–ª–∏ –ø–µ—Ä–µ–¥–∞–Ω –∞—Ä–≥—É–º–µ–Ω—Ç --kill, —É–±–∏–≤–∞–µ–º –≤—Å–µ –ø—Ä–æ—Ü–µ—Å—Å—ã kolibri_node_v1
if [[ "$1" == "--kill" ]]; then
    echo "üõë –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—Å–µ –ø—Ä–æ—Ü–µ—Å—Å—ã kolibri_node_v1..."
    pkill -f kolibri_node_v1 && echo "–í—Å–µ –ø—Ä–æ—Ü–µ—Å—Å—ã –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã"
    exit 0
fi

echo "üõë –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—Ç–∞—Ä—ã–µ –ø—Ä–æ—Ü–µ—Å—Å—ã kolibri_node_v1..."
pkill -f kolibri_node_v1 2>/dev/null
sleep 1

started=0

for ((digit=0; digit<MAX_NODES; digit++)); do
    port=$((BASE_PORT + digit))

    # –ü—Ä–æ–≤–µ—Ä–∫–∞: –µ—Å–ª–∏ –ø–æ—Ä—Ç –∑–∞–Ω—è—Ç ‚Äî –ø—Ä–æ–ø—É—Å–∫–∞–µ–º
    if lsof -i :$port >/dev/null 2>&1; then
        echo "‚ö†Ô∏è –ü–æ—Ä—Ç $port —É–∂–µ –∑–∞–Ω—è—Ç, —É–∑–µ–ª $digit –Ω–µ –±—É–¥–µ—Ç –∑–∞–ø—É—â–µ–Ω"
        continue
    fi

    echo "–ó–∞–ø—É—Å–∫ —É–∑–ª–∞ $digit –Ω–∞ –ø–æ—Ä—Ç—É $port"
    # –£–∑–µ–ª –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –≤ —Ñ–æ–Ω–µ, –º–æ–∂–Ω–æ –ø–µ—Ä–µ–¥–∞—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä –¥–ª—è –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
    ./bin/kolibri_node_v1 --id node$digit --port $port --digit $digit &
    sleep 0.1
    ((started++))
done

echo "‚úÖ –ó–∞–ø—É—â–µ–Ω–æ $started —É–∑–ª–æ–≤ –∏–∑ $MAX_NODES"

# –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ: –ø—Ä–æ–≤–µ—Ä–∫–∞ –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
WEB_PORT=8888
if lsof -i :$WEB_PORT >/dev/null 2>&1; then
    echo "üåê –í–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –¥–æ—Å—Ç—É–ø–µ–Ω –Ω–∞ –ø–æ—Ä—Ç—É $WEB_PORT"
else
    echo "‚ö†Ô∏è –í–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –Ω–µ –∑–∞–ø—É—â–µ–Ω –Ω–∞ –ø–æ—Ä—Ç—É $WEB_PORT"
fi
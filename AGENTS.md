# Kolibri Ω — Архитектура и продуктовая спецификация

> **Область действия.** Настоящий документ распространяется на весь репозиторий
> `pilot/` и служит единым источником требований для разработчиков и агентов
> автоматизации. Все изменения в каталоге должны соответствовать ожиданиям,
> изложенным ниже.

## 0. Видение и миссия

Создать новый класс искусственного интеллекта, работающего исключительно с
десятичными цифрами, формулами и программами Δ-VM. Целевое ядро ≤ 50 МБ должно
быть переносимым, поддерживать диалог, самообучение, синтез знаний и обмен в
сети, предоставляя демонстрацию уровня «world-class».

## 1. Архитектура решения

### 1.1 Δ-VM v2 — десятичная виртуальная машина

- **Инструкции:** `PUSHd`, `ADD10`, `SUB10`, `MUL10`, `DIV10`, `CMP`, `JZ`,
  `JNZ`, `CALL`, `RET`, `READ_FKV`, `WRITE_FKV`, `HASH10`, `RANDOM10`, `TIME10`,
  `HALT`.
- **Модель:** стековая, строго детерминированная с ограничением по «газу» для
  предотвращения бесконечных циклов.
- **Трассировка:** JSON-лог каждого шага (регистры, стек, последние операции)
  для обучения и отладки.
- **Производительность:** выполнение программы длиной 256 шагов — P95 < 50 мс
  на x86-64/ARM.
- **Реализация:** C, threaded interpreter, таблица переходов, опциональный JIT
  на критичных путях.

### 1.2 F-KV v2 — фрактальная память base-10

- **Структура:** 10-арный trie с хранением top-K элементов (программы, факты)
  по префиксу.
- **Типы памяти:**
  - Эпизодическая (диалоги, события).
  - Семантическая (факты, формулы, связи).
  - Процедурная (байткод Δ-VM).
- **API:** `fkv_put`, `fkv_get_prefix`, `fkv_topk_programs`.
- **Сжатие:** десятичное арифметическое кодирование.
- **Цели:** ≥ 1 млн ключей, P95 GET < 10 мс.

### 1.3 Синтез знаний

- **Парадигма:** знание = программа, обучение без весов.
- **Техники:** length-lexicographic перебор, MCTS, генетический поиск,
  peephole-оптимизации, sketching, частичная специализация.
- **Метрики:** `Score = W1*PoE - W2*MDL - W3*Runtime - W4*GasUsed`.
- **Вывод в продакшен:** только программы, повышающие PoE и снижающие MDL.

### 1.4 Блокчейн знаний

- **Формат блока:** `{prev_hash, time10, program_ids[], PoE_stats, MDL_delta,
  nonce}`.
- **Консенсус:** Proof-of-Use (PoU) — блок принимается при PoE ≥ τ.
- **Синхронизация:** gossip + CRDT OR-Set.
- **Безопасность:** подписи Ed25519, целостность HMAC-SHA256.

### 1.5 Сеть (роевой разум)

- **Кадры:** `HELLO`, `PING`, `PROGRAM_OFFER`, `BLOCK_OFFER`, `FKV_DELTA`, все
  поля — десятичные байты.
- **Регулирование:** лимиты частоты, репутация по доле полезных блоков.

### 1.6 Web UI «Kolibri Studio»

- **Архитектура:** SPA (Vite/React).
- **Вкладки:** диалог, память (F-KV Explorer), программы (редактор и трассировка
  Δ-VM), синтез (лог поиска), блокчейн (цепочка/блоки), кластер (состояние
  соседей), бенчмарки.
- **Назначение:** визуальный контроль, демонстрация и управление ИИ.

## 2. Публичный API (HTTP)

- `POST /api/v1/dialog {input} → {answer, trace}`
- `POST /api/v1/vm/run {program} → {result, trace}`
- `GET /api/v1/fkv/get?prefix=... → {values[], programs[]}`
- `POST /api/v1/program/submit {bytecode} → {PoE, MDL, score}`
- `POST /api/v1/chain/submit {program_id} → {status}`
- `GET /api/v1/health`, `GET /api/v1/metrics` → `{uptime, memory, peers, blocks}`

## 3. Ключевые показатели (KPI)

- Размер ядра ≤ 50 МБ, холодный старт < 300 мс.
- Время ответа P95 < 50 мс.
- Автоулучшение: рост PoE ≥ 20 % за ночь.
- ≥ 90 % блоков проходят повторную проверку.
- Репликация знаний < 3 с.
- 24 ч непрерывной работы, отчёты ASAN/UBSAN — без утечек.

## 4. Дорожная карта (спринты)

### Спринт A (3 недели) — ядро

- Δ-VM v2, F-KV v2.
- Метрики PoE/MDL.
- HTTP API v1.
- Kolibri Studio v1: Диалог + Память.
- CI: линтеры, unit-тесты для VM/F-KV.

### Спринт B (3 недели) — сеть и синтез

- Сетевой стек, синтез программ, блокчейн.
- Расширение Kolibri Studio: синтез, блоки, кластер.
- Масштабируемость и репликация знаний.

## 5. Демонстрационные сценарии (must-have)

1. **Арифметика:** запрос «2+2» → Δ-VM выдаёт 4.
2. **Запоминание факта:** «Запомни, что Москва — столица России» → запись в F-KV.
3. **Воспоминание:** «Вспомни столицу России» → ответ «Москва».
4. **Сетевой обмен:** сосед присылает программу с PoE=0.95 → валидация,
   добавление в блок, широковещание.

## 6. Инфраструктура и структура репозитория

```
/cfg          # Конфигурация
/docs         # Документация и спецификации
/include      # Публичные заголовки
/src          # Ядро Kolibri Ω (C)
/tests        # Unit, property, fuzz и интеграционные тесты
/web          # Kolibri Studio (React + Vite)
kolibri.sh    # Скрипт «всё в одном»
CMakeLists.txt, Makefile
```

## 7. Команда и процессы

- **Команды:** ядро (VM/F-KV), синтез + блокчейн, сеть, продукт/UX, DevOps/QA.
- **Стандарты:** code review, покрытие тестами, статический анализ,
  профилирование.
- **Коммуникации:** недельные демо, burn-down, канбан, документация в Wiki.

## 8. Риски и смягчающие меры

- Производительность trie → прототипы, профилировка.
- Сложность синтеза → MCTS + эвристики, property-based тесты.
- Безопасность протокола → code audit, криптографическая проверка.
- Правовые аспекты → патенты, экспортный контроль.

## 9. Definition of Done

- API соответствует требованиям по времени и формату.
- Kolibri Studio покрывает все ключевые сценарии.
- Сеть синхронизирует знания устойчиво.
- Документация (README Pro, Whitepaper, API Spec) завершена.
- Нагрузочные, профильные и security-тесты пройдены.
- Подготовлены презентационные материалы и сценарии запуска.

## 10. Резюме

Kolibri Ω — целостная архитектура цифрового интеллекта, основанного на
десятичных программах. Документ описывает ядро (Δ-VM, F-KV), синтез знаний,
блокчейн, сеть и продуктовый интерфейс, устанавливая KPI, дорожную карту и
требования к качеству. Следование спецификации гарантирует создание
масштабируемого и воспроизводимого продукта уровня «world-class demo».

---

**Инструкции для агентов:**

1. Соблюдайте структуру, перечисленную выше, и не вносите изменения, нарушающие
   целостность архитектуры без согласования с этим документом.
2. Перед коммитом запускайте предусмотренные тесты и проверки качества.
3. Документируйте любые расширения API или архитектуры, поддерживая единый
   стиль Markdown.
4. Соблюдайте требования по размеру ядра, производительности и отказоустойчивости
   при разработке новых функций.

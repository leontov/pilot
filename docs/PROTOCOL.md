# Kolibri Protocol

## 1. Общая концепция

Протокол Kolibri предназначен для взаимодействия узлов кластера и работает поверх транспортных протоколов TCP и UDP. Передача данных осуществляется в виде бинарных кадров, обеспечивающих компактность и эффективность обмена. Для аутентификации и целостности сообщений используется алгоритм HMAC-SHA256, что гарантирует защиту от подделки и несанкционированного доступа.

## 2. Формат кадра

Каждый кадр протокола Kolibri имеет следующий формат:

| Поле    | Размер (байт) | Описание                                     |
|---------|---------------|----------------------------------------------|
| MAGIC   | 2             | Магическое число для идентификации кадра     |
| VERSION | 1             | Версия протокола                             |
| TYPE    | 1             | Тип команды                                 |
| LEN     | 2             | Длина поля PAYLOAD                           |
| PAYLOAD | N             | Полезная нагрузка, зависит от типа команды  |
| HMAC    | 32            | HMAC-SHA256 подпись всего кадра (кроме HMAC)|
## 3. Типы команд

- **HELLO**: Инициализация соединения, обмен базовой информацией между узлами.
- **RULE**: Передача правил или конфигураций для обработки данных.
- **CMD_CREATOR**: Команда создания или управления задачами на узле.
- **ACK**: Подтверждение получения и обработки команды.
- **FREEZE**: Команда приостановки работы или блокировки ресурсов.
- **ERROR**: Сообщение об ошибке или некорректной обработке команды.
- **PING**: Проверка доступности узла (heartbeat, поддержка живости соединения).
- **ERROR**: Сообщение об ошибке или некорректной обработке команды.
- **MIGRATE_RULE**: Миграция лучшего правила между узлами для коллективного обучения.
## 3.1. TTL (Time-To-Live)

Каждое сообщение Kolibri содержит поле TTL (1 байт) в заголовке кадра. TTL определяет максимальное число хопов (переходов через узлы), после чего сообщение отбрасывается. Это предотвращает бесконечное распространение сообщений в кластере.

**Пример:**
TTL=8 (по умолчанию). Каждый раз при ретрансляции TTL уменьшается на 1. Если TTL=0 — сообщение не пересылается дальше.

## 4. Примеры обмена
## 4. Примеры обмена


### Пример кадра PING

```
MAGIC: 0xB1C0
VERSION: 1
TYPE: PING (0x09)
LEN: 0x0000
TTL: 0x08
HMAC: [32 байта HMAC-SHA256]
```

### Пример кадра HELLO

```
MAGIC: 0xB1C0
VERSION: 1
TYPE: HELLO (0x01)
LEN: 0x0005
TTL: 0x08
PAYLOAD: [0x10, 0x20, 0x30, 0x40, 0x50]
HMAC: [32 байта HMAC-SHA256]
```

### Пример кадра CMD_CREATOR с подписью

```
MAGIC: 0xB1C0
VERSION: 1
TYPE: CMD_CREATOR (0x07)
LEN: 0x000A
TTL: 0x08
PAYLOAD: [0x01, 0x02, ..., 0x0A]
HMAC: [32 байта HMAC-SHA256, рассчитанные с использованием root.key]
```

### Пример кадра MIGRATE_RULE

```
MAGIC: 0xB1C0
VERSION: 1
TYPE: MIGRATE_RULE (0x2A)
LEN: длина строки pattern|action|tier|fitness
TTL: 0x08
PAYLOAD: "temp>30|fan_on|2|0.98"
HMAC: [32 байта HMAC-SHA256]
```

## 5. Безопасность

Все кадры протокола подписываются с помощью HMAC-SHA256, используя секретный ключ `root.key`. Это обеспечивает проверку подлинности и целостности данных. Узлы кластера отбрасывают любые кадры, которые не содержат корректной подписи или имеют неверный HMAC, что предотвращает атаки типа "человек посередине" и подделку сообщений.

## 6. План развития

- Переход на асимметричную криптографию с использованием Ed25519 для повышения безопасности и упрощения управления ключами.
- Расширение набора типов команд для поддержки новых функций и сценариев.
- Внедрение механизма gossip-discovery для автоматического обнаружения и интеграции новых узлов в кластер.

# Kolibri Ω Swarm Protocol v1

Протокол роевой сети описывает обмен кадрами между децентрализованными узлами Kolibri Ω. Все поля сериализуются в виде десятичных байтов (`'0'..'9'`), что обеспечивает совместимость с ограниченными средами Δ-VM и упрощает отладку. Каждое сообщение начинается с четырёх цифр версии протокола (`0001`), двух цифр типа кадра и фиксированного набора полей.

## Форматы кадров

| Тип кадра | Код | Назначение |
|-----------|-----|------------|
| `HELLO` | `10` | Первичное знакомство и публикация статуса узла |
| `PING` | `11` | Проверка доступности и оценка задержек |
| `PROGRAM_OFFER` | `12` | Рассылка программ Δ-VM с высоким PoE |
| `BLOCK_OFFER` | `13` | Анонс новых блоков цепочки знаний |
| `FKV_DELTA` | `14` | Репликация изменений фрактальной памяти |

### HELLO (`0001 10`)

| Поле | Длина (цифр) | Описание |
|------|--------------|----------|
| `version` | 2 | Версия программного стека узла |
| `node_id` | 16 | Десятичный идентификатор узла |
| `services` | 4 | Маска доступных сервисов (HTTP, VM, F-KV, блокчейн) |
| `reputation` | 3 | Текущее значение репутации (0-999) |

### PING (`0001 11`)

| Поле | Длина | Описание |
|------|-------|----------|
| `nonce` | 10 | Случайное значение запроса |
| `latency_hint_ms` | 5 | Локально измеренная задержка до соседа |

### PROGRAM_OFFER (`0001 12`)

| Поле | Длина | Описание |
|------|-------|----------|
| `program_id` | 16 | Десятичный идентификатор программы |
| `poe_milli` | 4 | Доказательство полезности ×1000 |
| `mdl_score` | 5 | Сжатый MDL-скор |
| `gas_used` | 6 | Газ, потраченный на исполнение |

### BLOCK_OFFER (`0001 13`)

| Поле | Длина | Описание |
|------|-------|----------|
| `block_id` | 16 | Идентификатор блока |
| `height` | 8 | Высота цепочки |
| `poe_milli` | 4 | Минимальный PoE в блоке ×1000 |
| `program_count` | 4 | Количество программ в блоке |

### FKV_DELTA (`0001 14`)

| Поле | Длина | Описание |
|------|-------|----------|
| `prefix` | 12 | Префикс trie (десятичный путь) |
| `entry_count` | 3 | Количество записей в дельте |
| `compressed_size` | 6 | Размер упакованной дельты в байтах |
| `checksum` | 5 | Контрольная сумма (модуль 100000) |

## Ограничения частоты

Для каждого типа кадра применяется токен-бакет с отдельной пропускной способностью.

| Кадр | Запас (burst) | Пополнение |
|------|---------------|------------|
| `HELLO` | 1 | 0.1 кадра/с (1 раз в 10 секунд) |
| `PING` | 3 | 1 кадр/с |
| `PROGRAM_OFFER` | 5 | 0.5 кадра/с |
| `BLOCK_OFFER` | 2 | 0.2 кадра/с |
| `FKV_DELTA` | 3 | 0.3 кадра/с |

При превышении лимита кадр отклоняется, а репутация отправителя понижается на 20 пунктов.

## Репутация узлов

Репутация хранится в диапазоне 0–1000 и управляет допуском к трафику.

| Диапазон | Класс |
|----------|-------|
| ≥850 | trusted |
| 600–849 | stable |
| 400–599 | neutral |
| 200–399 | suspect |
| <200 | blocked (кадры отвергаются) |

### Правила обновления

* Начальное значение — 600 (`stable`).
* Успешно обработанные кадры повышают репутацию:
  * `HELLO`: +10
  * `PING`: +5
  * `PROGRAM_OFFER`: +25
  * `BLOCK_OFFER`: +40
  * `FKV_DELTA`: +15
* Нарушение протокола (невалидные данные, отказ валидации) снижает репутацию на 80.
* Нарушение лимита частоты снижает репутацию на 20.
* Значение всегда ограничивается диапазоном 0–1000. При падении ниже 200 узел блокируется до восстановления.

## Процесс обработки кадра

1. Проверяется репутация соседа. Если класс `blocked`, кадр отклоняется без дальнейшей обработки.
2. Проверяется лимит частоты соответствующего типа. При нарушении — отклонение и штраф репутации.
3. Выполняется проверка цифровых полей и структуры кадра.
4. После успешной обработки начисляется вознаграждение и репутационный класс обновляется.

Эта реализация лежит в файлах `include/protocol/swarm.h` и `src/protocol/swarm.c` и покрыта юнит-тестами `tests/unit/test_swarm_protocol.c`.
